info:
  name: User API Contract Test
  type: http
  seq: 5

http:
  method: GET
  url: https://jsonplaceholder.typicode.com/users/{{userId}}
  params:
    - name: _format
      value: json
      type: query
      disabled: true

runtime:
  scripts:
    - type: before-request
      code: |-
        // Set up test data - use a valid user ID
        const testUserId = 1;
        bru.setVar('userId', testUserId);

        console.log(`Testing contract for user ID: ${testUserId}`);
    - type: after-response
      code: |-
        const body = res.getBody();

        // Log the response for debugging
        console.log('Response received:', JSON.stringify(body, null, 2));

        // Store user data for potential use in subsequent requests
        if (body && body.id) {
          bru.setVar('lastTestedUserId', body.id);
          bru.setVar('lastTestedUserName', body.name);
        }
    - type: tests
      code: |-
        const body = res.getBody();
        const headers = res.getHeaders();

        // ========================================
        // HTTP Response Contract Tests
        // ========================================

        test("Status code should be 200 OK", () => {
          expect(res.getStatus()).to.equal(200);
        });

        test("Content-Type header should be application/json", () => {
          const contentType = headers['content-type'];
          expect(contentType).to.exist;
          expect(contentType).to.include('application/json');
        });

        // ========================================
        // Response Body Structure Tests
        // ========================================

        test("Response body should be a valid object", () => {
          expect(body).to.be.an('object');
          expect(body).to.not.be.null;
        });

        // ========================================
        // Required Fields Contract Tests
        // ========================================

        test("Response must contain required field: id", () => {
          expect(body).to.have.property('id');
          expect(body.id).to.not.be.null;
          expect(body.id).to.not.be.undefined;
        });

        test("Response must contain required field: name", () => {
          expect(body).to.have.property('name');
          expect(body.name).to.not.be.null;
        });

        test("Response must contain required field: username", () => {
          expect(body).to.have.property('username');
          expect(body.username).to.not.be.null;
        });

        test("Response must contain required field: email", () => {
          expect(body).to.have.property('email');
          expect(body.email).to.not.be.null;
        });

        test("Response must contain required field: address", () => {
          expect(body).to.have.property('address');
          expect(body.address).to.be.an('object');
        });

        test("Response must contain required field: phone", () => {
          expect(body).to.have.property('phone');
        });

        test("Response must contain required field: website", () => {
          expect(body).to.have.property('website');
        });

        test("Response must contain required field: company", () => {
          expect(body).to.have.property('company');
          expect(body.company).to.be.an('object');
        });

        // ========================================
        // Data Type Contract Tests
        // ========================================

        test("Field 'id' must be a number", () => {
          expect(body.id).to.be.a('number');
        });

        test("Field 'name' must be a string", () => {
          expect(body.name).to.be.a('string');
        });

        test("Field 'username' must be a string", () => {
          expect(body.username).to.be.a('string');
        });

        test("Field 'email' must be a string", () => {
          expect(body.email).to.be.a('string');
        });

        test("Field 'phone' must be a string", () => {
          expect(body.phone).to.be.a('string');
        });

        test("Field 'website' must be a string", () => {
          expect(body.website).to.be.a('string');
        });

        // ========================================
        // Nested Object Structure Tests
        // ========================================

        test("Address object must contain required fields", () => {
          expect(body.address).to.have.property('street');
          expect(body.address).to.have.property('suite');
          expect(body.address).to.have.property('city');
          expect(body.address).to.have.property('zipcode');
          expect(body.address).to.have.property('geo');
        });

        test("Address fields must be correct types", () => {
          expect(body.address.street).to.be.a('string');
          expect(body.address.suite).to.be.a('string');
          expect(body.address.city).to.be.a('string');
          expect(body.address.zipcode).to.be.a('string');
          expect(body.address.geo).to.be.an('object');
        });

        test("Geo object must contain lat and lng coordinates", () => {
          expect(body.address.geo).to.have.property('lat');
          expect(body.address.geo).to.have.property('lng');
        });

        test("Geo coordinates must be valid strings", () => {
          expect(body.address.geo.lat).to.be.a('string');
          expect(body.address.geo.lng).to.be.a('string');
          // Verify they can be parsed as numbers
          expect(parseFloat(body.address.geo.lat)).to.be.a('number');
          expect(parseFloat(body.address.geo.lng)).to.be.a('number');
        });

        test("Company object must contain required fields", () => {
          expect(body.company).to.have.property('name');
          expect(body.company).to.have.property('catchPhrase');
          expect(body.company).to.have.property('bs');
        });

        test("Company fields must be strings", () => {
          expect(body.company.name).to.be.a('string');
          expect(body.company.catchPhrase).to.be.a('string');
          expect(body.company.bs).to.be.a('string');
        });

        // ========================================
        // Value Constraint Tests
        // ========================================

        test("User ID must be a positive integer", () => {
          expect(body.id).to.be.greaterThan(0);
          expect(Number.isInteger(body.id)).to.be.true;
        });

        test("Name must not be empty", () => {
          expect(body.name).to.have.length.greaterThan(0);
        });

        test("Username must not be empty", () => {
          expect(body.username).to.have.length.greaterThan(0);
        });

        test("Email must follow valid email format", () => {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          expect(body.email).to.match(emailRegex);
        });

        test("Email must not be empty", () => {
          expect(body.email).to.have.length.greaterThan(0);
        });

        test("Address city must not be empty", () => {
          expect(body.address.city).to.have.length.greaterThan(0);
        });

        test("Company name must not be empty", () => {
          expect(body.company.name).to.have.length.greaterThan(0);
        });

        // ========================================
        // Optional Fields Handling Tests
        // ========================================

        test("All expected fields are present (no extra required fields)", () => {
          const requiredFields = ['id', 'name', 'username', 'email', 'address', 'phone', 'website', 'company'];
          requiredFields.forEach(field => {
            expect(body).to.have.property(field);
          });
        });

        test("Response structure matches complete contract", () => {
          // Comprehensive structure validation
          expect(body).to.be.an('object');
          expect(Object.keys(body)).to.include.members(['id', 'name', 'username', 'email', 'address', 'phone', 'website', 'company']);
        });
  assertions:
    - expression: res.status
      operator: eq
      value: "200"
    - expression: res.body
      operator: isJson
    - expression: res.body.id
      operator: isNumber
    - expression: res.body.name
      operator: isString
    - expression: res.body.email
      operator: isString

settings:
  encodeUrl: true
  timeout: 0
  followRedirects: true
  maxRedirects: 5

docs: |-
  ### Contract Testing Example

  This request demonstrates comprehensive contract testing for a User API endpoint.

  **What is Contract Testing?**
  Contract testing validates that an API response conforms to an expected schema/contract.

  **This example validates:**

  1. **HTTP Response Contract**
     - Status code is 200
     - Content-Type header is application/json

  2. **Response Structure**
     - Body is a valid JSON object
     - All required fields are present

  3. **Data Types**
     - id is a number
     - name, username, email, phone, website are strings
     - address and company are objects

  4. **Nested Object Structure**
     - address contains street, suite, city, zipcode, geo
     - geo contains lat and lng coordinates
     - company contains name, catchPhrase, bs

  5. **Value Constraints**
     - id is a positive integer
     - email follows email format
     - Strings are not empty
     - Coordinates are valid numbers

  **API Endpoint:** JSONPlaceholder Users API
  **Documentation:** https://jsonplaceholder.typicode.com/

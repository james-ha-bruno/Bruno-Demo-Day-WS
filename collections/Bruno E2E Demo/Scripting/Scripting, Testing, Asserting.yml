info:
  name: Scripting, Testing, Asserting
  type: http
  seq: 2

http:
  method: GET
  url: https://newsapi.org/v2/everything?q=nvidia&sortBy=publishedAt&from=2025-09-01
  params:
    - name: q
      value: nvidia
      type: query
    - name: sortBy
      value: publishedAt
      type: query
    - name: from
      value: "{{validDate}}"
      type: query
      disabled: true
    - name: from
      value: 2025-09-01
      type: query
  auth:
    type: apikey
    key: apiKey
    value: fc8d3ad5e238407ea83d80c2008fc0fa
    placement: query

runtime:
  scripts:
    - type: before-request
      code: |-
        // Get today's date
        const today = new Date();

        // Subtract 28 days
        const pastDate = new Date(today);
        pastDate.setDate(today.getDate() - 28);

        // Format as YYYY-MM-DD
        const formatted = pastDate.toISOString().split('T')[0];

        // Save as a Bruno variable
        bru.setVar('validDate', formatted);

        // Optional: log to console
        console.log('Date 28 days ago:', formatted);
    - type: after-response
      code: |-
        test("returns 200 OK", () => {
          expect(res.status).to.equal(200);
        });
    - type: tests
      code: |-
        const body = res.getBody();

        test("returns 200 OK", () => {
          expect(res.status).to.equal(200);
        });

        test("top-level shape is correct", () => {
          expect(body).to.be.an("object");
          expect(body.status).to.equal("ok");
          expect(body.totalResults).to.be.a("number").and.satisfy(n => Number.isInteger(n) && n >= 0);
          expect(body.articles).to.be.an("array");
          // totalResults should be >= articles length when pagination is used
          expect(body.totalResults).to.be.at.least(body.articles.length);
        });
  assertions:
    - expression: res.status
      operator: eq
      value: "200"
      disabled: true
    - expression: res.body.totalResults
      operator: isNumber
      disabled: true
    - expression: res.body
      operator: isJson
      disabled: true

settings:
  encodeUrl: true
  timeout: 0
  followRedirects: true
  maxRedirects: 5
